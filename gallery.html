<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lightã‚µãƒ¼ãƒãƒ¼ - ã‚®ãƒ£ãƒ©ãƒªãƒ¼</title>
  <link rel="stylesheet" href="assets/style.css">
  <style>
    .video-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      padding: 20px;
    }
    .video-container {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
      background: #f9f9f9;
    }
    .video-title {
      margin: 0 0 10px;
      font-size: 1.2em;
      color: #333;
    }
    .video-wrapper {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
    }
    .video-wrapper iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      max-width: 100%;
      border-radius: 5px;
    }
    .loading {
      text-align: center;
      font-size: 1.2em;
      padding: 20px;
    }
    .error-message {
      color: red;
      font-size: 1.2em;
      text-align: center;
      padding: 20px;
    }
    .sort-buttons {
      text-align: center;
      margin: 20px;
    }
    .sort-buttons button {
      padding: 10px 20px;
      font-size: 1em;
      margin: 0 10px;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f0f0f0;
    }

    /* BGMã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
    .bgm-controls {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(255,255,255,0.9);
      padding: 10px 15px;
      border: 1px solid #ccc;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
    }
    .bgm-controls button {
      padding: 5px 10px;
    }
    .bgm-controls input[type="range"] {
      width: 100px;
    }
  </style>
</head>
<body>
  <header>
    <h1>ã‚®ãƒ£ãƒ©ãƒªãƒ¼</h1>
    <nav>
      <ul>
        <li><a href="index.html">ãƒˆãƒƒãƒ—</a></li>
        <li><a href="status.html">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</a></li>
        <li><a href="gallery.html">ã‚®ãƒ£ãƒ©ãƒªãƒ¼</a></li>
        <li><a href="todo.html">ã‚„ã‚ŠãŒãŸã„ã“ã¨</a></li>
        <li><a href="submit.html">å‹•ç”»æŠ•ç¨¿</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <h2>ã‚²ãƒ¼ãƒ å‹•ç”»ã‚¯ãƒªãƒƒãƒ—</h2>
    <p><a href="submit.html">æ–°ã—ã„å‹•ç”»ã‚’æŠ•ç¨¿ã™ã‚‹</a></p>
    <div class="sort-buttons">
      <button id="sort-latest">æœ€æ–°é †</button>
      <button id="sort-oldest">æœ€å¤é †</button>
    </div>
    <div class="loading" id="loading">å‹•ç”»ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
    <div class="video-gallery" id="video-gallery"></div>
    <div class="loading" id="loading-more" style="display:none; text-align:center;">ã•ã‚‰ã«èª­ã¿è¾¼ã‚€...</div>
  </main>

  <!-- ğŸµ BGMãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
  <audio id="bgm" src="assets/bgm.mp3" autoplay loop></audio>
  <div class="bgm-controls">
    <button id="bgm-toggle">ğŸ”Š ON</button>
    <input id="bgm-volume" type="range" min="0" max="1" step="0.01" value="1">
  </div>

  <script>
    // BGM çŠ¶æ…‹ç®¡ç†
    const bgm = document.getElementById("bgm");
    const toggleBtn = document.getElementById("bgm-toggle");
    const volumeSlider = document.getElementById("bgm-volume");

    window.addEventListener("load", () => {
      const savedTime = sessionStorage.getItem("bgm-time");
      const savedPaused = sessionStorage.getItem("bgm-paused");
      const savedVolume = sessionStorage.getItem("bgm-volume");

      if (savedTime) bgm.currentTime = parseFloat(savedTime);
      if (savedVolume) {
        bgm.volume = parseFloat(savedVolume);
        volumeSlider.value = savedVolume;
      }

      if (savedPaused === "true") {
        bgm.pause();
        toggleBtn.textContent = "ğŸ”‡ OFF";
      } else {
        bgm.play().catch(() => {});
        toggleBtn.textContent = "ğŸ”Š ON";
      }
    });

    // çŠ¶æ…‹ã‚’1ç§’ã”ã¨ã«ä¿å­˜
    setInterval(() => {
      sessionStorage.setItem("bgm-time", bgm.currentTime);
      sessionStorage.setItem("bgm-paused", bgm.paused);
      sessionStorage.setItem("bgm-volume", bgm.volume);
    }, 1000);

    toggleBtn.addEventListener("click", () => {
      if (bgm.paused) {
        bgm.play();
        toggleBtn.textContent = "ğŸ”Š ON";
      } else {
        bgm.pause();
        toggleBtn.textContent = "ğŸ”‡ OFF";
      }
    });

    volumeSlider.addEventListener("input", () => {
      bgm.volume = volumeSlider.value;
    });

    // ğŸ¥ å‹•ç”»è¡¨ç¤ºå‡¦ç†ï¼ˆãã®ã¾ã¾ï¼‰
    let nextPageToken = 0;
    const videosPerPage = 5;
    let videosData = [];

    async function fetchVideos() {
      const SHEET_ID = '1IMVmbJCQtb82AbKeR_0BiS35zkTNDeytgyLEbYtj-mA';
      const API_KEY = 'AIzaSyCK3jCuAtLoM9v3ajt-LYMdJ8DKfAmDvo8';
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­” 1!A2:D?key=${API_KEY}`;
      try {
        const response = await fetch(url);
        const data = await response.json();
        videosData = data.values || [];
        document.getElementById('loading').style.display = 'none';
        displayVideos(videosData.slice(nextPageToken, nextPageToken + videosPerPage));
        nextPageToken += videosPerPage;
        document.getElementById('loading-more').style.display = 'block';
      } catch (error) {
        console.error('å‹•ç”»å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('video-gallery').innerHTML = '<p class="error-message">å‹•ç”»ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
      }
    }

    function displayVideos(videos) {
      const gallery = document.getElementById('video-gallery');
      gallery.innerHTML = '';
      videos.forEach(([timestamp, title, url, videoId]) => {
        if (videoId) {
          const videoElement = `
            <div class="video-container">
              <h3 class="video-title">${title}</h3>
              <div class="video-wrapper">
                <iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen loading="lazy"></iframe>
              </div>
            </div>`;
          gallery.innerHTML += videoElement;
        }
      });
    }

    window.onscroll = () => {
      if (window.innerHeight + window.scrollY >= document.documentElement.scrollHeight - 200) {
        document.getElementById('loading-more').innerHTML = 'å‹•ç”»ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...';
        displayVideos(videosData.slice(nextPageToken, nextPageToken + videosPerPage));
        nextPageToken += videosPerPage;
      }
    };

    document.getElementById('sort-latest').addEventListener('click', () => {
      const sortedVideos = [...videosData].sort((a, b) => new Date(b[0]) - new Date(a[0]));
      nextPageToken = 0;
      displayVideos(sortedVideos.slice(nextPageToken, nextPageToken + videosPerPage));
      nextPageToken += videosPerPage;
    });

    document.getElementById('sort-oldest').addEventListener('click', () => {
      const sortedVideos = [...videosData].sort((a, b) => new Date(a[0]) - new Date(b[0]));
      nextPageToken = 0;
      displayVideos(sortedVideos.slice(nextPageToken, nextPageToken + videosPerPage));
      nextPageToken += videosPerPage;
    });

    fetchVideos();
  </script>
</body>
</html>
